<!doctype html>
<html lang="ja">
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <title>ウェブサイト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="期末課題用のサンプルウェブサイトです。">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background-image: url('images/live.jpg'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat; overflow: hidden; height: 100vh;">
    <header>
        <div class="clock" id="clock"></div>
        <div class="daily-song" id="daily-song">
            <h3>本日の一曲はこちら</h3>
            <div class="daily-song-content" id="daily-song-content">
                <div class="daily-song-no-songs" id="no-songs-message" style="display: none;">
                    楽曲リストが空です
                </div>
                <img id="song-image" src="" alt="今日の楽曲" style="display: none;">
                <div class="daily-song-info" id="song-info" style="display: none;">
                    <div class="daily-song-title" id="song-title"></div>
                    <div class="daily-song-artist" id="song-artist"></div>
                </div>
            </div>
        </div>
        <h1>私のウェブサイト</h1>
        <nav>
            <ul>
                <li><a href="index.html">ホーム</a></li>
                <li><a href="profile.html#">プロフィール</a></li>
                <li><a href="like.html">好きなもの</a></li>
                <li><a href="ktc.html">お問い合わせ</a></li>
            </ul>
        </nav>
    </header>
    <main style="background: transparent;">
        <section>
            <p style="text-align: center; font-size: 3em;">Welcome</p>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 私のウェブサイト</p>
    </footer>
    
    <!-- 楽曲管理モーダル -->
    <div class="song-manager-modal" id="song-manager-modal">
        <div class="song-manager-content">
            <div class="song-manager-header">
                <h2>楽曲リスト管理</h2>
                <button class="close-modal" onclick="closeSongManager()">&times;</button>
            </div>
            
            <div class="song-form">
                <h3>新しい楽曲を追加</h3>
                <div class="song-form-row">
                    <input type="text" id="new-song-title" placeholder="曲名" required>
                    <input type="text" id="new-song-artist" placeholder="アーティスト" required>
                    <input type="text" id="new-song-image" placeholder="画像パス (images/xxx.jpg)" required style="display: none;">
                    <button class="add-song-btn" onclick="addSong()">追加</button>
                </div>
                
                <div class="spotify-section" style="margin-top: 1.5em; padding-top: 1.5em; border-top: 1px solid #e9ecef;">
                    <h4>🎵 Spotify連携</h4>
                    <div id="spotify-status" style="margin-bottom: 1em;">
                        <span id="spotify-connection-status">未接続</span>
                    </div>
                    <div class="spotify-controls">
                        <!-- ボタンの onclick を PKCE 対応関数へ変更 -->
                        <button id="spotify-auth-btn" class="add-song-btn" onclick="startSpotifyAuthPKCE()" style="background: #1db954;">
                            Spotifyと接続
                        </button>
                        <button id="spotify-add-btn" class="add-song-btn" onclick="addCurrentSpotifyTrack()" style="background: #1db954; display: none;">
                            再生中の楽曲を追加
                        </button>
                        <button id="spotify-disconnect-btn" class="add-song-btn" onclick="disconnectSpotify()" style="background: #e74c3c; display: none;">
                            接続解除
                        </button>
                    </div>
                    <div id="current-track-info" style="margin-top: 1em; font-size: 0.9em; color: #666; display: none;"></div>
                </div>
            </div>
            
            <div>
                <h3>現在の楽曲リスト (<span id="song-count">0</span>曲)</h3>
                <div class="song-list" id="song-list">
                    <!-- 楽曲リストがここに表示されます -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Spotify Web API設定 (PKCE対応)
        const SPOTIFY_CONFIG = {
            CLIENT_ID: '5367989a704647cf8fab23a82776c862',
            REDIRECT_URI: 'https://n03234.github.io/about-me/index.html',
            SCOPES: 'user-read-currently-playing user-read-playback-state'
        };
        
        // ローカルストレージキー
        const SONGS_STORAGE_KEY = 'dailySongs';
        const SPOTIFY_ACCESS_TOKEN_KEY = 'spotify_access_token';
        const SPOTIFY_REFRESH_TOKEN_KEY = 'spotify_refresh_token';
        const SPOTIFY_EXPIRES_AT_KEY = 'spotify_expires_at';
        const SPOTIFY_CODE_VERIFIER_KEY = 'spotify_code_verifier';
        const SPOTIFY_STATE_KEY = 'spotify_auth_state';
        
        // デフォルト楽曲データ（初回のみ使用）
        const defaultSongs = [
            { title: "夜明けの詩", artist: "乃木坂46", image: "images/yoake.jpg" },
            { title: "絶愛", artist: "櫻坂46", image: "images/zetuai.webp" },
            { title: "感情", artist: "日向坂46", image: "images/kanzyou.jpg" },
            { title: "大丈夫", artist: "乃木坂46", image: "images/daizyoubu.jpg" },
            { title: "Kiss me 幸せ", artist: "櫻坂46", image: "images/kissme-.jpg" }
        ];

        function loadSongs() {
            const stored = localStorage.getItem(SONGS_STORAGE_KEY);
            if (stored) return JSON.parse(stored);
            saveSongs(defaultSongs);
            return defaultSongs;
        }
        function saveSongs(songs) { localStorage.setItem(SONGS_STORAGE_KEY, JSON.stringify(songs)); }

        // ===================== PKCE ユーティリティ =====================
        function generateRandomString(length = 128) {
            const array = new Uint8Array(length); crypto.getRandomValues(array);
            return Array.from(array).map(b => ('0' + (b & 0xff).toString(16)).slice(-2)).join('');
        }
        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        }
        function saveTokens(tokenResponse) {
            const { access_token, refresh_token, expires_in } = tokenResponse;
            if (access_token) {
                localStorage.setItem(SPOTIFY_ACCESS_TOKEN_KEY, access_token);
                const expiresAt = Date.now() + ((expires_in || 3600) - 60) * 1000; // 余裕 60秒
                localStorage.setItem(SPOTIFY_EXPIRES_AT_KEY, String(expiresAt));
            }
            // refresh_token が返らないケースもあるため上書き時のみ保存
            if (refresh_token) localStorage.setItem(SPOTIFY_REFRESH_TOKEN_KEY, refresh_token);
        }
        function getStoredAccessToken() { return localStorage.getItem(SPOTIFY_ACCESS_TOKEN_KEY); }
        function isAccessTokenExpired() {
            const expiresAt = localStorage.getItem(SPOTIFY_EXPIRES_AT_KEY);
            return !expiresAt || Date.now() >= Number(expiresAt);
        }
        async function refreshAccessTokenIfNeeded() {
            if (!getStoredAccessToken() || !isAccessTokenExpired()) return getStoredAccessToken();
            const refreshToken = localStorage.getItem(SPOTIFY_REFRESH_TOKEN_KEY);
            if (!refreshToken) { return null; }
            try {
                const body = new URLSearchParams({
                    client_id: SPOTIFY_CONFIG.CLIENT_ID,
                    grant_type: 'refresh_token',
                    refresh_token: refreshToken
                });
                const resp = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
                if (!resp.ok) {
                    console.warn('トークンリフレッシュ失敗', await resp.text());
                    disconnectSpotify(false);
                    return null;
                }
                const data = await resp.json();
                saveTokens(data);
                return getStoredAccessToken();
            } catch(e){ console.error('リフレッシュエラー', e); return null; }
        }
        async function getValidAccessToken() {
            if (!getStoredAccessToken()) return null;
            if (isAccessTokenExpired()) return await refreshAccessTokenIfNeeded();
            return getStoredAccessToken();
        }

        // ===================== 認証フロー =====================
        async function authenticateSpotify() {
            const state = Math.random().toString(36).slice(2);
            const codeVerifier = generateRandomString(64);
            localStorage.setItem(SPOTIFY_STATE_KEY, state);
            localStorage.setItem(SPOTIFY_CODE_VERIFIER_KEY, codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: SPOTIFY_CONFIG.CLIENT_ID,
                scope: SPOTIFY_CONFIG.SCOPES,
                redirect_uri: SPOTIFY_CONFIG.REDIRECT_URI,
                state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
        }
        // ボタンが startSpotifyAuthPKCE を呼ぶためエイリアス
        function startSpotifyAuthPKCE(){ authenticateSpotify(); }

        async function handleSpotifyCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');
            if (error) { console.error('Spotify 認証エラー:', error); cleanupAuthParams(); return; }
            if (!code) return; // コールバックでない
            const storedState = localStorage.getItem(SPOTIFY_STATE_KEY);
            if (state !== storedState) { console.warn('state 不一致'); cleanupAuthParams(); return; }
            const codeVerifier = localStorage.getItem(SPOTIFY_CODE_VERIFIER_KEY);
            if (!codeVerifier) { console.warn('code_verifier 不在'); cleanupAuthParams(); return; }
            try {
                const body = new URLSearchParams({
                    client_id: SPOTIFY_CONFIG.CLIENT_ID,
                    grant_type: 'authorization_code',
                    code,
                    redirect_uri: SPOTIFY_CONFIG.REDIRECT_URI,
                    code_verifier: codeVerifier
                });
                const resp = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
                if (!resp.ok) {
                    console.error('トークン取得失敗', await resp.text());
                    alert('Spotify 認証に失敗しました。');
                } else {
                    const data = await resp.json();
                    saveTokens(data);
                }
            } catch(e){
                console.error('トークン交換エラー', e);
                alert('トークン交換エラー');
            } finally {
                cleanupAuthParams();
            }
        }
        function cleanupAuthParams() {
            if (window.history.replaceState) {
                const url = new URL(window.location.href); url.search='';
                window.history.replaceState({}, document.title, url.toString());
            }
            localStorage.removeItem(SPOTIFY_STATE_KEY);
            localStorage.removeItem(SPOTIFY_CODE_VERIFIER_KEY);
        }
        function disconnectSpotify(showAlert = true) {
            localStorage.removeItem(SPOTIFY_ACCESS_TOKEN_KEY);
            localStorage.removeItem(SPOTIFY_REFRESH_TOKEN_KEY);
            localStorage.removeItem(SPOTIFY_EXPIRES_AT_KEY);
            updateSpotifyStatus();
            if (showAlert) alert('Spotifyとの接続を解除しました。');
        }

        // 現在再生中
        async function getCurrentPlayingTrack() {
            const token = await getValidAccessToken();
            if (!token) return null;
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', { headers:{ Authorization:'Bearer '+token } });
                if (response.status === 401) { disconnectSpotify(false); return null; }
                if (response.status === 204 || !response.ok) return null;
                const data = await response.json();
                if (!data || !data.item) return null;
                return { title: data.item.name, artist: data.item.artists.map(a=>a.name).join(', '), image:'images/default.jpg', isPlaying: data.is_playing };
            } catch(e){ console.error('Spotify API Error', e); return null; }
        }
        async function addCurrentSpotifyTrack(){
            const track = await getCurrentPlayingTrack();
            if (!track) { alert('再生中の楽曲が見つかりません。'); return; }
            const songs = loadSongs();
            if (songs.some(s => s.title === track.title && s.artist === track.artist)) { alert('既に追加済みです。'); return; }
            songs.push(track); saveSongs(songs); updateSongList(); updateDailySong(); alert(`「${track.title}」を追加しました。`);
        }
        function updateSpotifyStatus() {
            const token = getStoredAccessToken();
            const statusElement = document.getElementById('spotify-connection-status');
            const authBtn = document.getElementById('spotify-auth-btn');
            const addBtn = document.getElementById('spotify-add-btn');
            const disconnectBtn = document.getElementById('spotify-disconnect-btn');
            const currentTrackInfo = document.getElementById('current-track-info');
            if (token) {
                statusElement.textContent = '✅ 接続済み'; statusElement.style.color = '#1db954';
                authBtn.style.display='none'; addBtn.style.display='inline-block'; disconnectBtn.style.display='inline-block';
                getCurrentPlayingTrack().then(track => {
                    if (track) { currentTrackInfo.innerHTML = `<strong>再生中:</strong> ${track.title} - ${track.artist} ${track.isPlaying ? '▶️':'⏸️'}`; }
                    else { currentTrackInfo.innerHTML = '<em>再生中の楽曲がありません</em>'; }
                    currentTrackInfo.style.display='block';
                });
            } else {
                statusElement.textContent='❌ 未接続'; statusElement.style.color='#666';
                authBtn.style.display='inline-block'; addBtn.style.display='none'; disconnectBtn.style.display='none'; currentTrackInfo.style.display='none';
            }
        }

        // ===================== UI / 楽曲ロジック（既存） =====================
        function updateClock(){ const now=new Date(); document.getElementById('clock').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`; }
        function getDailySong(){ const songs=loadSongs(); if(!songs.length) return null; const d=new Date(); const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; let hash=0; for(let i=0;i<dateStr.length;i++){ hash=((hash<<5)-hash)+dateStr.charCodeAt(i); hash|=0;} return songs[Math.abs(hash)%songs.length]; }
        function updateDailySong(){ const song=getDailySong(); const noMsg=document.getElementById('no-songs-message'); const img=document.getElementById('song-image'); const info=document.getElementById('song-info'); const t=document.getElementById('song-title'); const a=document.getElementById('song-artist'); if(song){ noMsg.style.display='none'; img.style.display='none'; info.style.display='block'; img.src=song.image; img.alt=song.title; t.textContent=song.title; a.textContent=song.artist;} else { noMsg.style.display='block'; img.style.display='none'; info.style.display='none'; } }
        function openSongManager(){ document.getElementById('song-manager-modal').style.display='flex'; updateSongList(); updateSpotifyStatus(); }
        function closeSongManager(){ document.getElementById('song-manager-modal').style.display='none'; }
        function addSong(){ const title=document.getElementById('new-song-title').value.trim(); const artist=document.getElementById('new-song-artist').value.trim(); const image='images/default.jpg'; if(!title||!artist){ alert('曲名とアーティストを入力してください。'); return;} const songs=loadSongs(); songs.push({title,artist,image}); saveSongs(songs); document.getElementById('new-song-title').value=''; document.getElementById('new-song-artist').value=''; updateSongList(); updateDailySong(); }
        function deleteSong(i){ if(confirm('この楽曲を削除しますか？')){ const songs=loadSongs(); songs.splice(i,1); saveSongs(songs); updateSongList(); updateDailySong(); } }
        function updateSongList(){ const songs=loadSongs(); const list=document.getElementById('song-list'); const cnt=document.getElementById('song-count'); cnt.textContent=songs.length; if(!songs.length){ list.innerHTML='<div style="padding:2em;text-align:center;color:#666;">楽曲が登録されていません</div>'; return;} list.innerHTML=songs.map((s,i)=>`<div class="song-item-row"><div class="song-item-info"><div class="song-item-title">${s.title}</div><div class="song-item-artist">${s.artist}</div></div><button class="delete-song-btn" onclick="deleteSong(${i})">削除</button></div>`).join(''); }
        document.getElementById('song-manager-modal').addEventListener('click',e=>{ if(e.target===e.currentTarget) closeSongManager(); });
        document.addEventListener('keypress',e=>{ if(e.key==='Enter' && document.getElementById('song-manager-modal').style.display==='flex'){ const ae=document.activeElement; if(ae.id==='new-song-title'||ae.id==='new-song-artist') addSong(); }});
        document.addEventListener('keydown',e=>{ if(e.ctrlKey&&e.shiftKey&&e.key==='M'){ e.preventDefault(); openSongManager(); }});
        // 楽曲管理画面のダブルクリックアクセス無効化：セキュリティのため削除
        // document.getElementById('daily-song').addEventListener('dblclick',openSongManager);

        // ===================== 初期化 =====================
        setInterval(updateClock,1000); updateClock(); updateDailySong();
        let lastDate=new Date().getDate(); setInterval(()=>{ const cd=new Date().getDate(); if(cd!==lastDate){ updateDailySong(); lastDate=cd;} },60000);

        (async function initSpotifyPKCE(){
            await handleSpotifyCallback(); // code パラメータがあれば処理
            updateSpotifyStatus();
        })();
    </script>
</body>
</html>
