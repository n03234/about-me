<!doctype html>
<html lang="ja">
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <title>ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="æœŸæœ«èª²é¡Œç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã™ã€‚">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background-image: url('images/live.jpg'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat; overflow: hidden; height: 100vh;">
    <header>
        <div class="clock" id="clock"></div>
        <div class="daily-song" id="daily-song">
            <h3>æœ¬æ—¥ã®ä¸€æ›²ã¯ã“ã¡ã‚‰</h3>
            <div class="daily-song-content" id="daily-song-content">
                <div class="daily-song-no-songs" id="no-songs-message" style="display: none;">
                    æ¥½æ›²ãƒªã‚¹ãƒˆãŒç©ºã§ã™
                </div>
                <img id="song-image" src="" alt="ä»Šæ—¥ã®æ¥½æ›²" style="display: none;">
                <div class="daily-song-info" id="song-info" style="display: none;">
                    <div class="daily-song-title" id="song-title"></div>
                    <div class="daily-song-artist" id="song-artist"></div>
                </div>
            </div>
        </div>
        <h1>ç§ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</h1>
        <nav>
            <ul>
                <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="profile.html#">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a></li>
                <li><a href="like.html">å¥½ããªã‚‚ã®</a></li>
                <li><a href="ktc.html">ãŠå•ã„åˆã‚ã›</a></li>
            </ul>
        </nav>
    </header>
    <main style="background: transparent;">
        <section>
            <p style="text-align: center; font-size: 3em;">Welcome</p>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 ç§ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</p>
    </footer>
    
    <!-- æ¥½æ›²ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="song-manager-modal" id="song-manager-modal">
        <div class="song-manager-content">
            <div class="song-manager-header">
                <h2>æ¥½æ›²ãƒªã‚¹ãƒˆç®¡ç†</h2>
                <button class="close-modal" onclick="closeSongManager()">&times;</button>
            </div>
            
            <div class="song-form">
                <h3>æ–°ã—ã„æ¥½æ›²ã‚’è¿½åŠ </h3>
                <div class="song-form-row">
                    <input type="text" id="new-song-title" placeholder="æ›²å" required>
                    <input type="text" id="new-song-artist" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ" required>
                    <input type="text" id="new-song-image" placeholder="ç”»åƒãƒ‘ã‚¹ (images/xxx.jpg)" required style="display: none;">
                    <button class="add-song-btn" onclick="addSong()">è¿½åŠ </button>
                </div>
                
                <div class="spotify-section" style="margin-top: 1.5em; padding-top: 1.5em; border-top: 1px solid #e9ecef;">
                    <h4>ğŸµ Spotifyé€£æº</h4>
                    <div id="spotify-status" style="margin-bottom: 1em;">
                        <span id="spotify-connection-status">æœªæ¥ç¶š</span>
                    </div>
                    <div class="spotify-controls">
                        <!-- ãƒœã‚¿ãƒ³ã® onclick ã‚’ PKCE å¯¾å¿œé–¢æ•°ã¸å¤‰æ›´ -->
                        <button id="spotify-auth-btn" class="add-song-btn" onclick="startSpotifyAuthPKCE()" style="background: #1db954;">
                            Spotifyã¨æ¥ç¶š
                        </button>
                        <button id="spotify-add-btn" class="add-song-btn" onclick="addCurrentSpotifyTrack()" style="background: #1db954; display: none;">
                            å†ç”Ÿä¸­ã®æ¥½æ›²ã‚’è¿½åŠ 
                        </button>
                        <button id="spotify-disconnect-btn" class="add-song-btn" onclick="disconnectSpotify()" style="background: #e74c3c; display: none;">
                            æ¥ç¶šè§£é™¤
                        </button>
                    </div>
                    <div id="current-track-info" style="margin-top: 1em; font-size: 0.9em; color: #666; display: none;"></div>
                </div>
            </div>
            
            <div>
                <h3>ç¾åœ¨ã®æ¥½æ›²ãƒªã‚¹ãƒˆ (<span id="song-count">0</span>æ›²)</h3>
                <div class="song-list" id="song-list">
                    <!-- æ¥½æ›²ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Spotify Web APIè¨­å®š (PKCEå¯¾å¿œ)
        const SPOTIFY_CONFIG = {
            CLIENT_ID: '5367989a704647cf8fab23a82776c862',
            REDIRECT_URI: 'https://n03234.github.io/about-me/index.html',
            SCOPES: 'user-read-currently-playing user-read-playback-state'
        };
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const SONGS_STORAGE_KEY = 'dailySongs';
        const SPOTIFY_ACCESS_TOKEN_KEY = 'spotify_access_token';
        const SPOTIFY_REFRESH_TOKEN_KEY = 'spotify_refresh_token';
        const SPOTIFY_EXPIRES_AT_KEY = 'spotify_expires_at';
        const SPOTIFY_CODE_VERIFIER_KEY = 'spotify_code_verifier';
        const SPOTIFY_STATE_KEY = 'spotify_auth_state';
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¥½æ›²ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿ä½¿ç”¨ï¼‰
        const defaultSongs = [
            { title: "å¤œæ˜ã‘ã®è©©", artist: "ä¹ƒæœ¨å‚46", image: "images/yoake.jpg" },
            { title: "çµ¶æ„›", artist: "æ«»å‚46", image: "images/zetuai.webp" },
            { title: "æ„Ÿæƒ…", artist: "æ—¥å‘å‚46", image: "images/kanzyou.jpg" },
            { title: "å¤§ä¸ˆå¤«", artist: "ä¹ƒæœ¨å‚46", image: "images/daizyoubu.jpg" },
            { title: "Kiss me å¹¸ã›", artist: "æ«»å‚46", image: "images/kissme-.jpg" }
        ];

        function loadSongs() {
            const stored = localStorage.getItem(SONGS_STORAGE_KEY);
            if (stored) return JSON.parse(stored);
            saveSongs(defaultSongs);
            return defaultSongs;
        }
        function saveSongs(songs) { localStorage.setItem(SONGS_STORAGE_KEY, JSON.stringify(songs)); }

        // ===================== PKCE ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£ =====================
        function generateRandomString(length = 128) {
            const array = new Uint8Array(length); crypto.getRandomValues(array);
            return Array.from(array).map(b => ('0' + (b & 0xff).toString(16)).slice(-2)).join('');
        }
        async function generateCodeChallenge(verifier) {
            const data = new TextEncoder().encode(verifier);
            const digest = await crypto.subtle.digest('SHA-256', data);
            return btoa(String.fromCharCode(...new Uint8Array(digest))).replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
        }
        function saveTokens(tokenResponse) {
            const { access_token, refresh_token, expires_in } = tokenResponse;
            if (access_token) {
                localStorage.setItem(SPOTIFY_ACCESS_TOKEN_KEY, access_token);
                const expiresAt = Date.now() + ((expires_in || 3600) - 60) * 1000; // ä½™è£• 60ç§’
                localStorage.setItem(SPOTIFY_EXPIRES_AT_KEY, String(expiresAt));
            }
            // refresh_token ãŒè¿”ã‚‰ãªã„ã‚±ãƒ¼ã‚¹ã‚‚ã‚ã‚‹ãŸã‚ä¸Šæ›¸ãæ™‚ã®ã¿ä¿å­˜
            if (refresh_token) localStorage.setItem(SPOTIFY_REFRESH_TOKEN_KEY, refresh_token);
        }
        function getStoredAccessToken() { return localStorage.getItem(SPOTIFY_ACCESS_TOKEN_KEY); }
        function isAccessTokenExpired() {
            const expiresAt = localStorage.getItem(SPOTIFY_EXPIRES_AT_KEY);
            return !expiresAt || Date.now() >= Number(expiresAt);
        }
        async function refreshAccessTokenIfNeeded() {
            if (!getStoredAccessToken() || !isAccessTokenExpired()) return getStoredAccessToken();
            const refreshToken = localStorage.getItem(SPOTIFY_REFRESH_TOKEN_KEY);
            if (!refreshToken) { return null; }
            try {
                const body = new URLSearchParams({
                    client_id: SPOTIFY_CONFIG.CLIENT_ID,
                    grant_type: 'refresh_token',
                    refresh_token: refreshToken
                });
                const resp = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
                if (!resp.ok) {
                    console.warn('ãƒˆãƒ¼ã‚¯ãƒ³ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥å¤±æ•—', await resp.text());
                    disconnectSpotify(false);
                    return null;
                }
                const data = await resp.json();
                saveTokens(data);
                return getStoredAccessToken();
            } catch(e){ console.error('ãƒªãƒ•ãƒ¬ãƒƒã‚·ãƒ¥ã‚¨ãƒ©ãƒ¼', e); return null; }
        }
        async function getValidAccessToken() {
            if (!getStoredAccessToken()) return null;
            if (isAccessTokenExpired()) return await refreshAccessTokenIfNeeded();
            return getStoredAccessToken();
        }

        // ===================== èªè¨¼ãƒ•ãƒ­ãƒ¼ =====================
        async function authenticateSpotify() {
            const state = Math.random().toString(36).slice(2);
            const codeVerifier = generateRandomString(64);
            localStorage.setItem(SPOTIFY_STATE_KEY, state);
            localStorage.setItem(SPOTIFY_CODE_VERIFIER_KEY, codeVerifier);
            const codeChallenge = await generateCodeChallenge(codeVerifier);
            const params = new URLSearchParams({
                response_type: 'code',
                client_id: SPOTIFY_CONFIG.CLIENT_ID,
                scope: SPOTIFY_CONFIG.SCOPES,
                redirect_uri: SPOTIFY_CONFIG.REDIRECT_URI,
                state,
                code_challenge_method: 'S256',
                code_challenge: codeChallenge
            });
            window.location.href = 'https://accounts.spotify.com/authorize?' + params.toString();
        }
        // ãƒœã‚¿ãƒ³ãŒ startSpotifyAuthPKCE ã‚’å‘¼ã¶ãŸã‚ã‚¨ã‚¤ãƒªã‚¢ã‚¹
        function startSpotifyAuthPKCE(){ authenticateSpotify(); }

        async function handleSpotifyCallback() {
            const params = new URLSearchParams(window.location.search);
            const code = params.get('code');
            const state = params.get('state');
            const error = params.get('error');
            if (error) { console.error('Spotify èªè¨¼ã‚¨ãƒ©ãƒ¼:', error); cleanupAuthParams(); return; }
            if (!code) return; // ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã§ãªã„
            const storedState = localStorage.getItem(SPOTIFY_STATE_KEY);
            if (state !== storedState) { console.warn('state ä¸ä¸€è‡´'); cleanupAuthParams(); return; }
            const codeVerifier = localStorage.getItem(SPOTIFY_CODE_VERIFIER_KEY);
            if (!codeVerifier) { console.warn('code_verifier ä¸åœ¨'); cleanupAuthParams(); return; }
            try {
                const body = new URLSearchParams({
                    client_id: SPOTIFY_CONFIG.CLIENT_ID,
                    grant_type: 'authorization_code',
                    code,
                    redirect_uri: SPOTIFY_CONFIG.REDIRECT_URI,
                    code_verifier: codeVerifier
                });
                const resp = await fetch('https://accounts.spotify.com/api/token', { method:'POST', headers:{'Content-Type':'application/x-www-form-urlencoded'}, body });
                if (!resp.ok) {
                    console.error('ãƒˆãƒ¼ã‚¯ãƒ³å–å¾—å¤±æ•—', await resp.text());
                    alert('Spotify èªè¨¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
                } else {
                    const data = await resp.json();
                    saveTokens(data);
                }
            } catch(e){
                console.error('ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ã‚¨ãƒ©ãƒ¼', e);
                alert('ãƒˆãƒ¼ã‚¯ãƒ³äº¤æ›ã‚¨ãƒ©ãƒ¼');
            } finally {
                cleanupAuthParams();
            }
        }
        function cleanupAuthParams() {
            if (window.history.replaceState) {
                const url = new URL(window.location.href); url.search='';
                window.history.replaceState({}, document.title, url.toString());
            }
            localStorage.removeItem(SPOTIFY_STATE_KEY);
            localStorage.removeItem(SPOTIFY_CODE_VERIFIER_KEY);
        }
        function disconnectSpotify(showAlert = true) {
            localStorage.removeItem(SPOTIFY_ACCESS_TOKEN_KEY);
            localStorage.removeItem(SPOTIFY_REFRESH_TOKEN_KEY);
            localStorage.removeItem(SPOTIFY_EXPIRES_AT_KEY);
            updateSpotifyStatus();
            if (showAlert) alert('Spotifyã¨ã®æ¥ç¶šã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
        }

        // ç¾åœ¨å†ç”Ÿä¸­
        async function getCurrentPlayingTrack() {
            const token = await getValidAccessToken();
            if (!token) return null;
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', { headers:{ Authorization:'Bearer '+token } });
                if (response.status === 401) { disconnectSpotify(false); return null; }
                if (response.status === 204 || !response.ok) return null;
                const data = await response.json();
                if (!data || !data.item) return null;
                return { title: data.item.name, artist: data.item.artists.map(a=>a.name).join(', '), image:'images/default.jpg', isPlaying: data.is_playing };
            } catch(e){ console.error('Spotify API Error', e); return null; }
        }
        async function addCurrentSpotifyTrack(){
            const track = await getCurrentPlayingTrack();
            if (!track) { alert('å†ç”Ÿä¸­ã®æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚'); return; }
            const songs = loadSongs();
            if (songs.some(s => s.title === track.title && s.artist === track.artist)) { alert('æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™ã€‚'); return; }
            songs.push(track); saveSongs(songs); updateSongList(); updateDailySong(); alert(`ã€Œ${track.title}ã€ã‚’è¿½åŠ ã—ã¾ã—ãŸã€‚`);
        }
        function updateSpotifyStatus() {
            const token = getStoredAccessToken();
            const statusElement = document.getElementById('spotify-connection-status');
            const authBtn = document.getElementById('spotify-auth-btn');
            const addBtn = document.getElementById('spotify-add-btn');
            const disconnectBtn = document.getElementById('spotify-disconnect-btn');
            const currentTrackInfo = document.getElementById('current-track-info');
            if (token) {
                statusElement.textContent = 'âœ… æ¥ç¶šæ¸ˆã¿'; statusElement.style.color = '#1db954';
                authBtn.style.display='none'; addBtn.style.display='inline-block'; disconnectBtn.style.display='inline-block';
                getCurrentPlayingTrack().then(track => {
                    if (track) { currentTrackInfo.innerHTML = `<strong>å†ç”Ÿä¸­:</strong> ${track.title} - ${track.artist} ${track.isPlaying ? 'â–¶ï¸':'â¸ï¸'}`; }
                    else { currentTrackInfo.innerHTML = '<em>å†ç”Ÿä¸­ã®æ¥½æ›²ãŒã‚ã‚Šã¾ã›ã‚“</em>'; }
                    currentTrackInfo.style.display='block';
                });
            } else {
                statusElement.textContent='âŒ æœªæ¥ç¶š'; statusElement.style.color='#666';
                authBtn.style.display='inline-block'; addBtn.style.display='none'; disconnectBtn.style.display='none'; currentTrackInfo.style.display='none';
            }
        }

        // ===================== UI / æ¥½æ›²ãƒ­ã‚¸ãƒƒã‚¯ï¼ˆæ—¢å­˜ï¼‰ =====================
        function updateClock(){ const now=new Date(); document.getElementById('clock').textContent = `${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}:${String(now.getSeconds()).padStart(2,'0')}`; }
        function getDailySong(){ const songs=loadSongs(); if(!songs.length) return null; const d=new Date(); const dateStr=`${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`; let hash=0; for(let i=0;i<dateStr.length;i++){ hash=((hash<<5)-hash)+dateStr.charCodeAt(i); hash|=0;} return songs[Math.abs(hash)%songs.length]; }
        function updateDailySong(){ const song=getDailySong(); const noMsg=document.getElementById('no-songs-message'); const img=document.getElementById('song-image'); const info=document.getElementById('song-info'); const t=document.getElementById('song-title'); const a=document.getElementById('song-artist'); if(song){ noMsg.style.display='none'; img.style.display='none'; info.style.display='block'; img.src=song.image; img.alt=song.title; t.textContent=song.title; a.textContent=song.artist;} else { noMsg.style.display='block'; img.style.display='none'; info.style.display='none'; } }
        function openSongManager(){ document.getElementById('song-manager-modal').style.display='flex'; updateSongList(); updateSpotifyStatus(); }
        function closeSongManager(){ document.getElementById('song-manager-modal').style.display='none'; }
        function addSong(){ const title=document.getElementById('new-song-title').value.trim(); const artist=document.getElementById('new-song-artist').value.trim(); const image='images/default.jpg'; if(!title||!artist){ alert('æ›²åã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚'); return;} const songs=loadSongs(); songs.push({title,artist,image}); saveSongs(songs); document.getElementById('new-song-title').value=''; document.getElementById('new-song-artist').value=''; updateSongList(); updateDailySong(); }
        function deleteSong(i){ if(confirm('ã“ã®æ¥½æ›²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')){ const songs=loadSongs(); songs.splice(i,1); saveSongs(songs); updateSongList(); updateDailySong(); } }
        function updateSongList(){ const songs=loadSongs(); const list=document.getElementById('song-list'); const cnt=document.getElementById('song-count'); cnt.textContent=songs.length; if(!songs.length){ list.innerHTML='<div style="padding:2em;text-align:center;color:#666;">æ¥½æ›²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>'; return;} list.innerHTML=songs.map((s,i)=>`<div class="song-item-row"><div class="song-item-info"><div class="song-item-title">${s.title}</div><div class="song-item-artist">${s.artist}</div></div><button class="delete-song-btn" onclick="deleteSong(${i})">å‰Šé™¤</button></div>`).join(''); }
        document.getElementById('song-manager-modal').addEventListener('click',e=>{ if(e.target===e.currentTarget) closeSongManager(); });
        document.addEventListener('keypress',e=>{ if(e.key==='Enter' && document.getElementById('song-manager-modal').style.display==='flex'){ const ae=document.activeElement; if(ae.id==='new-song-title'||ae.id==='new-song-artist') addSong(); }});
        document.addEventListener('keydown',e=>{ if(e.ctrlKey&&e.shiftKey&&e.key==='M'){ e.preventDefault(); openSongManager(); }});
        // æ¥½æ›²ç®¡ç†ç”»é¢ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç„¡åŠ¹åŒ–ï¼šã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã®ãŸã‚å‰Šé™¤
        // document.getElementById('daily-song').addEventListener('dblclick',openSongManager);

        // ===================== åˆæœŸåŒ– =====================
        setInterval(updateClock,1000); updateClock(); updateDailySong();
        let lastDate=new Date().getDate(); setInterval(()=>{ const cd=new Date().getDate(); if(cd!==lastDate){ updateDailySong(); lastDate=cd;} },60000);

        (async function initSpotifyPKCE(){
            await handleSpotifyCallback(); // code ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãŒã‚ã‚Œã°å‡¦ç†
            updateSpotifyStatus();
        })();
    </script>
</body>
</html>
