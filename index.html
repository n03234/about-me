<!doctype html>
<html lang="ja">
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <title>ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="æœŸæœ«èª²é¡Œç”¨ã®ã‚µãƒ³ãƒ—ãƒ«ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã§ã™ã€‚">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background-image: url('images/live.jpg'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat; overflow: hidden; height: 100vh;">
    <header>
        <div class="clock" id="clock"></div>
        <div class="daily-song" id="daily-song">
            <h3>æœ¬æ—¥ã®ä¸€æ›²ã¯ã“ã¡ã‚‰</h3>
            <div class="daily-song-content" id="daily-song-content">
                <div class="daily-song-no-songs" id="no-songs-message" style="display: none;">
                    æ¥½æ›²ãƒªã‚¹ãƒˆãŒç©ºã§ã™
                </div>
                <img id="song-image" src="" alt="ä»Šæ—¥ã®æ¥½æ›²" style="display: none;">
                <div class="daily-song-info" id="song-info" style="display: none;">
                    <div class="daily-song-title" id="song-title"></div>
                    <div class="daily-song-artist" id="song-artist"></div>
                </div>
            </div>
        </div>
        <h1>ç§ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</h1>
        <nav>
            <ul>
                <li><a href="index.html">ãƒ›ãƒ¼ãƒ </a></li>
                <li><a href="profile.html#">ãƒ—ãƒ­ãƒ•ã‚£ãƒ¼ãƒ«</a></li>
                <li><a href="like.html">å¥½ããªã‚‚ã®</a></li>
                <li><a href="ktc.html">ãŠå•ã„åˆã‚ã›</a></li>
            </ul>
        </nav>
    </header>
    <main style="background: transparent;">
        <section>
            <p style="text-align: center; font-size: 3em;">Welcome</p>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 ç§ã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆ</p>
    </footer>
    
    <!-- æ¥½æ›²ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
    <div class="song-manager-modal" id="song-manager-modal">
        <div class="song-manager-content">
            <div class="song-manager-header">
                <h2>æ¥½æ›²ãƒªã‚¹ãƒˆç®¡ç†</h2>
                <button class="close-modal" onclick="closeSongManager()">&times;</button>
            </div>
            
            <div class="song-form">
                <h3>æ–°ã—ã„æ¥½æ›²ã‚’è¿½åŠ </h3>
                <div class="song-form-row">
                    <input type="text" id="new-song-title" placeholder="æ›²å" required>
                    <input type="text" id="new-song-artist" placeholder="ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆ" required>
                    <input type="text" id="new-song-image" placeholder="ç”»åƒãƒ‘ã‚¹ (images/xxx.jpg)" required style="display: none;">
                    <button class="add-song-btn" onclick="addSong()">è¿½åŠ </button>
                </div>
                
                <div class="spotify-section" style="margin-top: 1.5em; padding-top: 1.5em; border-top: 1px solid #e9ecef;">
                    <h4>ğŸµ Spotifyé€£æº</h4>
                    <div id="spotify-status" style="margin-bottom: 1em;">
                        <span id="spotify-connection-status">æœªæ¥ç¶š</span>
                    </div>
                    <div class="spotify-controls">
                        <button id="spotify-auth-btn" class="add-song-btn" onclick="authenticateSpotify()" style="background: #1db954;">
                            Spotifyã¨æ¥ç¶š
                        </button>
                        <button id="spotify-add-btn" class="add-song-btn" onclick="addCurrentSpotifyTrack()" style="background: #1db954; display: none;">
                            å†ç”Ÿä¸­ã®æ¥½æ›²ã‚’è¿½åŠ 
                        </button>
                        <button id="spotify-disconnect-btn" class="add-song-btn" onclick="disconnectSpotify()" style="background: #e74c3c; display: none;">
                            æ¥ç¶šè§£é™¤
                        </button>
                    </div>
                    <div id="current-track-info" style="margin-top: 1em; font-size: 0.9em; color: #666; display: none;"></div>
                </div>
            </div>
            
            <div>
                <h3>ç¾åœ¨ã®æ¥½æ›²ãƒªã‚¹ãƒˆ (<span id="song-count">0</span>æ›²)</h3>
                <div class="song-list" id="song-list">
                    <!-- æ¥½æ›²ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Spotify Web APIè¨­å®š
        const SPOTIFY_CONFIG = {
            CLIENT_ID: '5367989a704647cf8fab23a82776c862', // ã“ã“ã«Spotifyã‚¢ãƒ—ãƒªã®Client IDã‚’è¨­å®š
            REDIRECT_URI: 'https://n03234.github.io/about-me/index.html', // ã“ã“ã«ã‚ãªãŸã®ã‚¦ã‚§ãƒ–ã‚µã‚¤ãƒˆã®URLã‚’è¨­å®š
            SCOPES: 'user-read-currently-playing user-read-playback-state'
        };
        
        // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã‚­ãƒ¼
        const SONGS_STORAGE_KEY = 'dailySongs';
        const SPOTIFY_TOKEN_KEY = 'spotifyAccessToken';
        
        // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¥½æ›²ãƒ‡ãƒ¼ã‚¿ï¼ˆåˆå›ã®ã¿ä½¿ç”¨ï¼‰
        const defaultSongs = [
            { title: "å¤œæ˜ã‘ã®è©©", artist: "ä¹ƒæœ¨å‚46", image: "images/yoake.jpg" },
            { title: "çµ¶æ„›", artist: "æ«»å‚46", image: "images/zetuai.webp" },
            { title: "æ„Ÿæƒ…", artist: "æ—¥å‘å‚46", image: "images/kanzyou.jpg" },
            { title: "å¤§ä¸ˆå¤«", artist: "ä¹ƒæœ¨å‚46", image: "images/daizyoubu.jpg" },
            { title: "Kiss me å¹¸ã›", artist: "æ«»å‚46", image: "images/kissme-.jpg" }
        ];

        // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
        function loadSongs() {
            const stored = localStorage.getItem(SONGS_STORAGE_KEY);
            if (stored) {
                return JSON.parse(stored);
            } else {
                // åˆå›èµ·å‹•æ™‚ã¯ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆæ¥½æ›²ã‚’è¨­å®š
                saveSongs(defaultSongs);
                return defaultSongs;
            }
        }
        
        // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
        function saveSongs(songs) {
            localStorage.setItem(SONGS_STORAGE_KEY, JSON.stringify(songs));
        }
        
        // Spotifyèªè¨¼
        function authenticateSpotify() {
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('spotify_auth_state', state);
            
            const authUrl = 'https://accounts.spotify.com/authorize?' +
                'response_type=token&' +
                'client_id=' + encodeURIComponent(SPOTIFY_CONFIG.CLIENT_ID) + '&' +
                'scope=' + encodeURIComponent(SPOTIFY_CONFIG.SCOPES) + '&' +
                'redirect_uri=' + encodeURIComponent(SPOTIFY_CONFIG.REDIRECT_URI) + '&' +
                'state=' + encodeURIComponent(state);
            
            window.location.href = authUrl;
        }
        
        // URLã‹ã‚‰ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        function getTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            const state = params.get('state');
            
            if (token && state === localStorage.getItem('spotify_auth_state')) {
                localStorage.setItem(SPOTIFY_TOKEN_KEY, token);
                localStorage.removeItem('spotify_auth_state');
                // URLã‹ã‚‰ãƒãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤
                window.location.hash = '';
                return token;
            }
            return null;
        }
        
        // ä¿å­˜ã•ã‚ŒãŸãƒˆãƒ¼ã‚¯ãƒ³ã‚’å–å¾—
        function getStoredToken() {
            return localStorage.getItem(SPOTIFY_TOKEN_KEY);
        }
        
        // ç¾åœ¨å†ç”Ÿä¸­ã®æ¥½æ›²ã‚’å–å¾—
        async function getCurrentPlayingTrack() {
            const token = getStoredToken();
            if (!token) return null;
            
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (response.status === 401) {
                    // ãƒˆãƒ¼ã‚¯ãƒ³æœŸé™åˆ‡ã‚Œ
                    localStorage.removeItem(SPOTIFY_TOKEN_KEY);
                    return null;
                }
                
                if (response.status === 204 || !response.ok) {
                    return null; // ä½•ã‚‚å†ç”Ÿã—ã¦ã„ãªã„
                }
                
                const data = await response.json();
                return {
                    title: data.item.name,
                    artist: data.item.artists.map(artist => artist.name).join(', '),
                    image: 'images/default.jpg', // ç”»åƒã¯ä½¿ç”¨ã—ãªã„ãŸã‚å›ºå®šå€¤
                    isPlaying: data.is_playing
                };
            } catch (error) {
                console.error('Spotify API Error:', error);
                return null;
            }
        }
        
        // Spotifyã‹ã‚‰æ¥½æ›²ã‚’ã€Œä»Šæ—¥ã®1æ›²ã€ã«è¿½åŠ 
        async function addCurrentSpotifyTrack() {
            const track = await getCurrentPlayingTrack();
            if (!track) {
                alert('ç¾åœ¨å†ç”Ÿä¸­ã®æ¥½æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã€‚Spotifyã§éŸ³æ¥½ã‚’å†ç”Ÿã—ã¦ã‹ã‚‰å†è©¦è¡Œã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const songs = loadSongs();
            // é‡è¤‡ãƒã‚§ãƒƒã‚¯
            const exists = songs.some(song => 
                song.title === track.title && song.artist === track.artist
            );
            
            if (exists) {
                alert('ã“ã®æ¥½æ›²ã¯æ—¢ã«ãƒªã‚¹ãƒˆã«è¿½åŠ ã•ã‚Œã¦ã„ã¾ã™ã€‚');
                return;
            }
            
            songs.push(track);
            saveSongs(songs);
            updateSongList();
            updateDailySong();
            alert(`ã€Œ${track.title}ã€ã‚’æ¥½æ›²ãƒªã‚¹ãƒˆã«è¿½åŠ ã—ã¾ã—ãŸï¼`);
        }
        
        // Spotifyæ¥ç¶šè§£é™¤
        function disconnectSpotify() {
            localStorage.removeItem(SPOTIFY_TOKEN_KEY);
            updateSpotifyStatus();
            alert('Spotifyã¨ã®æ¥ç¶šã‚’è§£é™¤ã—ã¾ã—ãŸã€‚');
        }
        
        // Spotifyã®æ¥ç¶šçŠ¶æ…‹ã‚’æ›´æ–°
        function updateSpotifyStatus() {
            const token = getStoredToken();
            const statusElement = document.getElementById('spotify-connection-status');
            const authBtn = document.getElementById('spotify-auth-btn');
            const addBtn = document.getElementById('spotify-add-btn');
            const disconnectBtn = document.getElementById('spotify-disconnect-btn');
            const currentTrackInfo = document.getElementById('current-track-info');
            
            if (token) {
                statusElement.textContent = 'âœ… æ¥ç¶šæ¸ˆã¿';
                statusElement.style.color = '#1db954';
                authBtn.style.display = 'none';
                addBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
                
                // ç¾åœ¨å†ç”Ÿä¸­ã®æ¥½æ›²æƒ…å ±ã‚’è¡¨ç¤º
                getCurrentPlayingTrack().then(track => {
                    if (track) {
                        currentTrackInfo.innerHTML = `
                            <strong>å†ç”Ÿä¸­:</strong> ${track.title} - ${track.artist}
                            ${track.isPlaying ? 'â–¶ï¸' : 'â¸ï¸'}
                        `;
                        currentTrackInfo.style.display = 'block';
                    } else {
                        currentTrackInfo.innerHTML = '<em>å†ç”Ÿä¸­ã®æ¥½æ›²ãŒã‚ã‚Šã¾ã›ã‚“</em>';
                        currentTrackInfo.style.display = 'block';
                    }
                });
            } else {
                statusElement.textContent = 'âŒ æœªæ¥ç¶š';
                statusElement.style.color = '#666';
                authBtn.style.display = 'inline-block';
                addBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                currentTrackInfo.style.display = 'none';
            }
        }
        
        // æ™‚è¨ˆæ›´æ–°
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            document.getElementById('clock').textContent = timeString;
        }
        
        // ä»Šæ—¥ã®æ¥½æ›²å–å¾—
        function getDailySong() {
            const songs = loadSongs();
            if (songs.length === 0) {
                return null;
            }
            
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                              String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(today.getDate()).padStart(2, '0');
            
            // æ—¥ä»˜æ–‡å­—åˆ—ã‚’ãƒãƒƒã‚·ãƒ¥åŒ–ã—ã¦æ¥½æ›²ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ±ºå®š
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                const char = dateString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 32bitæ•´æ•°ã«å¤‰æ›
            }
            
            const songIndex = Math.abs(hash) % songs.length;
            return songs[songIndex];
        }
        
        // ä»Šæ—¥ã®æ¥½æ›²è¡¨ç¤ºæ›´æ–°
        function updateDailySong() {
            const song = getDailySong();
            const noSongsMessage = document.getElementById('no-songs-message');
            const songImage = document.getElementById('song-image');
            const songInfo = document.getElementById('song-info');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            
            if (song) {
                noSongsMessage.style.display = 'none';
                songImage.style.display = 'none'; // ç”»åƒã¯å¸¸ã«éè¡¨ç¤º
                songInfo.style.display = 'block';
                
                // ç”»åƒè¨­å®šã¯ä¸è¦ã ãŒã€ãƒ‡ãƒ¼ã‚¿ä¿æŒã®ãŸã‚æ®‹ã™
                songImage.src = song.image;
                songImage.alt = song.title;
                songTitle.textContent = song.title;
                songArtist.textContent = song.artist;
            } else {
                noSongsMessage.style.display = 'block';
                songImage.style.display = 'none';
                songInfo.style.display = 'none';
            }
        }
        
        // æ¥½æ›²ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«é–‹ã
        function openSongManager() {
            document.getElementById('song-manager-modal').style.display = 'flex';
            updateSongList();
            updateSpotifyStatus();
        }
        
        // æ¥½æ›²ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ«é–‰ã˜ã‚‹
        function closeSongManager() {
            document.getElementById('song-manager-modal').style.display = 'none';
        }
        
        // æ¥½æ›²è¿½åŠ 
        function addSong() {
            const title = document.getElementById('new-song-title').value.trim();
            const artist = document.getElementById('new-song-artist').value.trim();
            const image = 'images/default.jpg'; // ç”»åƒã¯å›ºå®šå€¤
            
            if (!title || !artist) {
                alert('æ›²åã¨ã‚¢ãƒ¼ãƒ†ã‚£ã‚¹ãƒˆã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚');
                return;
            }
            
            const songs = loadSongs();
            songs.push({ title, artist, image });
            saveSongs(songs);
            
            // ãƒ•ã‚©ãƒ¼ãƒ ã‚¯ãƒªã‚¢
            document.getElementById('new-song-title').value = '';
            document.getElementById('new-song-artist').value = '';
            // ç”»åƒå…¥åŠ›æ¬„ã¯éè¡¨ç¤ºãªã®ã§ã‚¯ãƒªã‚¢ä¸è¦
            
            updateSongList();
            updateDailySong(); // æ¥½æ›²è¿½åŠ å¾Œã«ä»Šæ—¥ã®æ¥½æ›²ã‚’æ›´æ–°
        }
        
        // æ¥½æ›²å‰Šé™¤
        function deleteSong(index) {
            if (confirm('ã“ã®æ¥½æ›²ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                const songs = loadSongs();
                songs.splice(index, 1);
                saveSongs(songs);
                updateSongList();
                updateDailySong(); // æ¥½æ›²å‰Šé™¤å¾Œã«ä»Šæ—¥ã®æ¥½æ›²ã‚’æ›´æ–°
            }
        }
        
        // æ¥½æ›²ãƒªã‚¹ãƒˆè¡¨ç¤ºæ›´æ–°
        function updateSongList() {
            const songs = loadSongs();
            const songList = document.getElementById('song-list');
            const songCount = document.getElementById('song-count');
            
            songCount.textContent = songs.length;
            
            if (songs.length === 0) {
                songList.innerHTML = '<div style="padding: 2em; text-align: center; color: #666;">æ¥½æ›²ãŒç™»éŒ²ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>';
                return;
            }
            
            songList.innerHTML = songs.map((song, index) => `
                <div class="song-item-row">
                    <div class="song-item-info">
                        <div class="song-item-title">${song.title}</div>
                        <div class="song-item-artist">${song.artist}</div>
                    </div>
                    <button class="delete-song-btn" onclick="deleteSong(${index})">å‰Šé™¤</button>
                </div>
            `).join('');
        }
        
        // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.getElementById('song-manager-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSongManager();
            }
        });
        
        // Enterã‚­ãƒ¼ã§æ¥½æ›²è¿½åŠ 
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('song-manager-modal').style.display === 'flex') {
                const activeElement = document.activeElement;
                if (activeElement.id === 'new-song-title' || activeElement.id === 'new-song-artist') {
                    addSong();
                }
            }
        });
        
        // éš ã—ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã‚·ãƒ§ãƒ¼ãƒˆã‚«ãƒƒãƒˆï¼šCtrl+Shift+M ã§æ¥½æ›²ç®¡ç†ç”»é¢ã‚’é–‹ã
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'M') {
                e.preventDefault();
                openSongManager();
            }
        });
        
        // ä»Šæ—¥ã®æ¥½æ›²ã‚¨ãƒªã‚¢ã‚’ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§æ¥½æ›²ç®¡ç†ç”»é¢ã‚’é–‹ã
        document.getElementById('daily-song').addEventListener('dblclick', function() {
            openSongManager();
        });
        
        // åˆæœŸåŒ–
        setInterval(updateClock, 1000);
        updateClock();
        updateDailySong();
        
        // Spotifyèªè¨¼ãƒˆãƒ¼ã‚¯ãƒ³ã‚’URLã‹ã‚‰å–å¾—ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå¾Œï¼‰
        getTokenFromUrl();
        updateSpotifyStatus();
        
        // æ—¥ä»˜ãŒå¤‰ã‚ã£ãŸã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ1åˆ†ã”ã¨ï¼‰
        let lastDate = new Date().getDate();
        setInterval(() => {
            const currentDate = new Date().getDate();
            if (currentDate !== lastDate) {
                updateDailySong();
                lastDate = currentDate;
            }
        }, 60000);
    </script>
</body>
</html>
