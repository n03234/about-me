<!doctype html>
<html lang="ja">
<head>
    <link rel="stylesheet" href="css/style.css">
    <meta charset="UTF-8">
    <title>ウェブサイト</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="期末課題用のサンプルウェブサイトです。">
    <link rel="stylesheet" href="style.css">
</head>
<body style="background-image: url('images/live.jpg'); background-size: cover; background-position: center; background-attachment: fixed; background-repeat: no-repeat; overflow: hidden; height: 100vh;">
    <header>
        <div class="clock" id="clock"></div>
        <div class="daily-song" id="daily-song">
            <h3>本日の一曲はこちら</h3>
            <div class="daily-song-content" id="daily-song-content">
                <div class="daily-song-no-songs" id="no-songs-message" style="display: none;">
                    楽曲リストが空です
                </div>
                <img id="song-image" src="" alt="今日の楽曲" style="display: none;">
                <div class="daily-song-info" id="song-info" style="display: none;">
                    <div class="daily-song-title" id="song-title"></div>
                    <div class="daily-song-artist" id="song-artist"></div>
                </div>
            </div>
        </div>
        <h1>私のウェブサイト</h1>
        <nav>
            <ul>
                <li><a href="index.html">ホーム</a></li>
                <li><a href="profile.html#">プロフィール</a></li>
                <li><a href="like.html">好きなもの</a></li>
                <li><a href="ktc.html">お問い合わせ</a></li>
            </ul>
        </nav>
    </header>
    <main style="background: transparent;">
        <section>
            <p style="text-align: center; font-size: 3em;">Welcome</p>
        </section>
    </main>
    <footer>
        <p>&copy; 2025 私のウェブサイト</p>
    </footer>
    
    <!-- 楽曲管理モーダル -->
    <div class="song-manager-modal" id="song-manager-modal">
        <div class="song-manager-content">
            <div class="song-manager-header">
                <h2>楽曲リスト管理</h2>
                <button class="close-modal" onclick="closeSongManager()">&times;</button>
            </div>
            
            <div class="song-form">
                <h3>新しい楽曲を追加</h3>
                <div class="song-form-row">
                    <input type="text" id="new-song-title" placeholder="曲名" required>
                    <input type="text" id="new-song-artist" placeholder="アーティスト" required>
                    <input type="text" id="new-song-image" placeholder="画像パス (images/xxx.jpg)" required style="display: none;">
                    <button class="add-song-btn" onclick="addSong()">追加</button>
                </div>
                
                <div class="spotify-section" style="margin-top: 1.5em; padding-top: 1.5em; border-top: 1px solid #e9ecef;">
                    <h4>🎵 Spotify連携</h4>
                    <div id="spotify-status" style="margin-bottom: 1em;">
                        <span id="spotify-connection-status">未接続</span>
                    </div>
                    <div class="spotify-controls">
                        <button id="spotify-auth-btn" class="add-song-btn" onclick="authenticateSpotify()" style="background: #1db954;">
                            Spotifyと接続
                        </button>
                        <button id="spotify-add-btn" class="add-song-btn" onclick="addCurrentSpotifyTrack()" style="background: #1db954; display: none;">
                            再生中の楽曲を追加
                        </button>
                        <button id="spotify-disconnect-btn" class="add-song-btn" onclick="disconnectSpotify()" style="background: #e74c3c; display: none;">
                            接続解除
                        </button>
                    </div>
                    <div id="current-track-info" style="margin-top: 1em; font-size: 0.9em; color: #666; display: none;"></div>
                </div>
            </div>
            
            <div>
                <h3>現在の楽曲リスト (<span id="song-count">0</span>曲)</h3>
                <div class="song-list" id="song-list">
                    <!-- 楽曲リストがここに表示されます -->
                </div>
            </div>
        </div>
    </div>
    
    <script>
        // Spotify Web API設定
        const SPOTIFY_CONFIG = {
            CLIENT_ID: '5367989a704647cf8fab23a82776c862', // ここにSpotifyアプリのClient IDを設定
            REDIRECT_URI: 'https://n03234.github.io/about-me/index.html', // ここにあなたのウェブサイトのURLを設定
            SCOPES: 'user-read-currently-playing user-read-playback-state'
        };
        
        // ローカルストレージキー
        const SONGS_STORAGE_KEY = 'dailySongs';
        const SPOTIFY_TOKEN_KEY = 'spotifyAccessToken';
        
        // デフォルト楽曲データ（初回のみ使用）
        const defaultSongs = [
            { title: "夜明けの詩", artist: "乃木坂46", image: "images/yoake.jpg" },
            { title: "絶愛", artist: "櫻坂46", image: "images/zetuai.webp" },
            { title: "感情", artist: "日向坂46", image: "images/kanzyou.jpg" },
            { title: "大丈夫", artist: "乃木坂46", image: "images/daizyoubu.jpg" },
            { title: "Kiss me 幸せ", artist: "櫻坂46", image: "images/kissme-.jpg" }
        ];

        // 楽曲データの読み込み
        function loadSongs() {
            const stored = localStorage.getItem(SONGS_STORAGE_KEY);
            if (stored) {
                return JSON.parse(stored);
            } else {
                // 初回起動時はデフォルト楽曲を設定
                saveSongs(defaultSongs);
                return defaultSongs;
            }
        }
        
        // 楽曲データの保存
        function saveSongs(songs) {
            localStorage.setItem(SONGS_STORAGE_KEY, JSON.stringify(songs));
        }
        
        // Spotify認証
        function authenticateSpotify() {
            const state = Math.random().toString(36).substring(7);
            localStorage.setItem('spotify_auth_state', state);
            
            const authUrl = 'https://accounts.spotify.com/authorize?' +
                'response_type=token&' +
                'client_id=' + encodeURIComponent(SPOTIFY_CONFIG.CLIENT_ID) + '&' +
                'scope=' + encodeURIComponent(SPOTIFY_CONFIG.SCOPES) + '&' +
                'redirect_uri=' + encodeURIComponent(SPOTIFY_CONFIG.REDIRECT_URI) + '&' +
                'state=' + encodeURIComponent(state);
            
            window.location.href = authUrl;
        }
        
        // URLからアクセストークンを取得
        function getTokenFromUrl() {
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            const state = params.get('state');
            
            if (token && state === localStorage.getItem('spotify_auth_state')) {
                localStorage.setItem(SPOTIFY_TOKEN_KEY, token);
                localStorage.removeItem('spotify_auth_state');
                // URLからハッシュを削除
                window.location.hash = '';
                return token;
            }
            return null;
        }
        
        // 保存されたトークンを取得
        function getStoredToken() {
            return localStorage.getItem(SPOTIFY_TOKEN_KEY);
        }
        
        // 現在再生中の楽曲を取得
        async function getCurrentPlayingTrack() {
            const token = getStoredToken();
            if (!token) return null;
            
            try {
                const response = await fetch('https://api.spotify.com/v1/me/player/currently-playing', {
                    headers: {
                        'Authorization': 'Bearer ' + token
                    }
                });
                
                if (response.status === 401) {
                    // トークン期限切れ
                    localStorage.removeItem(SPOTIFY_TOKEN_KEY);
                    return null;
                }
                
                if (response.status === 204 || !response.ok) {
                    return null; // 何も再生していない
                }
                
                const data = await response.json();
                return {
                    title: data.item.name,
                    artist: data.item.artists.map(artist => artist.name).join(', '),
                    image: 'images/default.jpg', // 画像は使用しないため固定値
                    isPlaying: data.is_playing
                };
            } catch (error) {
                console.error('Spotify API Error:', error);
                return null;
            }
        }
        
        // Spotifyから楽曲を「今日の1曲」に追加
        async function addCurrentSpotifyTrack() {
            const track = await getCurrentPlayingTrack();
            if (!track) {
                alert('現在再生中の楽曲が見つかりません。Spotifyで音楽を再生してから再試行してください。');
                return;
            }
            
            const songs = loadSongs();
            // 重複チェック
            const exists = songs.some(song => 
                song.title === track.title && song.artist === track.artist
            );
            
            if (exists) {
                alert('この楽曲は既にリストに追加されています。');
                return;
            }
            
            songs.push(track);
            saveSongs(songs);
            updateSongList();
            updateDailySong();
            alert(`「${track.title}」を楽曲リストに追加しました！`);
        }
        
        // Spotify接続解除
        function disconnectSpotify() {
            localStorage.removeItem(SPOTIFY_TOKEN_KEY);
            updateSpotifyStatus();
            alert('Spotifyとの接続を解除しました。');
        }
        
        // Spotifyの接続状態を更新
        function updateSpotifyStatus() {
            const token = getStoredToken();
            const statusElement = document.getElementById('spotify-connection-status');
            const authBtn = document.getElementById('spotify-auth-btn');
            const addBtn = document.getElementById('spotify-add-btn');
            const disconnectBtn = document.getElementById('spotify-disconnect-btn');
            const currentTrackInfo = document.getElementById('current-track-info');
            
            if (token) {
                statusElement.textContent = '✅ 接続済み';
                statusElement.style.color = '#1db954';
                authBtn.style.display = 'none';
                addBtn.style.display = 'inline-block';
                disconnectBtn.style.display = 'inline-block';
                
                // 現在再生中の楽曲情報を表示
                getCurrentPlayingTrack().then(track => {
                    if (track) {
                        currentTrackInfo.innerHTML = `
                            <strong>再生中:</strong> ${track.title} - ${track.artist}
                            ${track.isPlaying ? '▶️' : '⏸️'}
                        `;
                        currentTrackInfo.style.display = 'block';
                    } else {
                        currentTrackInfo.innerHTML = '<em>再生中の楽曲がありません</em>';
                        currentTrackInfo.style.display = 'block';
                    }
                });
            } else {
                statusElement.textContent = '❌ 未接続';
                statusElement.style.color = '#666';
                authBtn.style.display = 'inline-block';
                addBtn.style.display = 'none';
                disconnectBtn.style.display = 'none';
                currentTrackInfo.style.display = 'none';
            }
        }
        
        // 時計更新
        function updateClock() {
            const now = new Date();
            const hours = String(now.getHours()).padStart(2, '0');
            const minutes = String(now.getMinutes()).padStart(2, '0');
            const seconds = String(now.getSeconds()).padStart(2, '0');
            const timeString = `${hours}:${minutes}:${seconds}`;
            document.getElementById('clock').textContent = timeString;
        }
        
        // 今日の楽曲取得
        function getDailySong() {
            const songs = loadSongs();
            if (songs.length === 0) {
                return null;
            }
            
            const today = new Date();
            const dateString = today.getFullYear() + '-' + 
                              String(today.getMonth() + 1).padStart(2, '0') + '-' + 
                              String(today.getDate()).padStart(2, '0');
            
            // 日付文字列をハッシュ化して楽曲インデックスを決定
            let hash = 0;
            for (let i = 0; i < dateString.length; i++) {
                const char = dateString.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash; // 32bit整数に変換
            }
            
            const songIndex = Math.abs(hash) % songs.length;
            return songs[songIndex];
        }
        
        // 今日の楽曲表示更新
        function updateDailySong() {
            const song = getDailySong();
            const noSongsMessage = document.getElementById('no-songs-message');
            const songImage = document.getElementById('song-image');
            const songInfo = document.getElementById('song-info');
            const songTitle = document.getElementById('song-title');
            const songArtist = document.getElementById('song-artist');
            
            if (song) {
                noSongsMessage.style.display = 'none';
                songImage.style.display = 'none'; // 画像は常に非表示
                songInfo.style.display = 'block';
                
                // 画像設定は不要だが、データ保持のため残す
                songImage.src = song.image;
                songImage.alt = song.title;
                songTitle.textContent = song.title;
                songArtist.textContent = song.artist;
            } else {
                noSongsMessage.style.display = 'block';
                songImage.style.display = 'none';
                songInfo.style.display = 'none';
            }
        }
        
        // 楽曲管理モーダル開く
        function openSongManager() {
            document.getElementById('song-manager-modal').style.display = 'flex';
            updateSongList();
            updateSpotifyStatus();
        }
        
        // 楽曲管理モーダル閉じる
        function closeSongManager() {
            document.getElementById('song-manager-modal').style.display = 'none';
        }
        
        // 楽曲追加
        function addSong() {
            const title = document.getElementById('new-song-title').value.trim();
            const artist = document.getElementById('new-song-artist').value.trim();
            const image = 'images/default.jpg'; // 画像は固定値
            
            if (!title || !artist) {
                alert('曲名とアーティストを入力してください。');
                return;
            }
            
            const songs = loadSongs();
            songs.push({ title, artist, image });
            saveSongs(songs);
            
            // フォームクリア
            document.getElementById('new-song-title').value = '';
            document.getElementById('new-song-artist').value = '';
            // 画像入力欄は非表示なのでクリア不要
            
            updateSongList();
            updateDailySong(); // 楽曲追加後に今日の楽曲を更新
        }
        
        // 楽曲削除
        function deleteSong(index) {
            if (confirm('この楽曲を削除しますか？')) {
                const songs = loadSongs();
                songs.splice(index, 1);
                saveSongs(songs);
                updateSongList();
                updateDailySong(); // 楽曲削除後に今日の楽曲を更新
            }
        }
        
        // 楽曲リスト表示更新
        function updateSongList() {
            const songs = loadSongs();
            const songList = document.getElementById('song-list');
            const songCount = document.getElementById('song-count');
            
            songCount.textContent = songs.length;
            
            if (songs.length === 0) {
                songList.innerHTML = '<div style="padding: 2em; text-align: center; color: #666;">楽曲が登録されていません</div>';
                return;
            }
            
            songList.innerHTML = songs.map((song, index) => `
                <div class="song-item-row">
                    <div class="song-item-info">
                        <div class="song-item-title">${song.title}</div>
                        <div class="song-item-artist">${song.artist}</div>
                    </div>
                    <button class="delete-song-btn" onclick="deleteSong(${index})">削除</button>
                </div>
            `).join('');
        }
        
        // モーダル外クリックで閉じる
        document.getElementById('song-manager-modal').addEventListener('click', function(e) {
            if (e.target === this) {
                closeSongManager();
            }
        });
        
        // Enterキーで楽曲追加
        document.addEventListener('keypress', function(e) {
            if (e.key === 'Enter' && document.getElementById('song-manager-modal').style.display === 'flex') {
                const activeElement = document.activeElement;
                if (activeElement.id === 'new-song-title' || activeElement.id === 'new-song-artist') {
                    addSong();
                }
            }
        });
        
        // 隠しキーボードショートカット：Ctrl+Shift+M で楽曲管理画面を開く
        document.addEventListener('keydown', function(e) {
            if (e.ctrlKey && e.shiftKey && e.key === 'M') {
                e.preventDefault();
                openSongManager();
            }
        });
        
        // 今日の楽曲エリアをダブルクリックで楽曲管理画面を開く
        document.getElementById('daily-song').addEventListener('dblclick', function() {
            openSongManager();
        });
        
        // 初期化
        setInterval(updateClock, 1000);
        updateClock();
        updateDailySong();
        
        // Spotify認証トークンをURLから取得（リダイレクト後）
        getTokenFromUrl();
        updateSpotifyStatus();
        
        // 日付が変わったかチェック（1分ごと）
        let lastDate = new Date().getDate();
        setInterval(() => {
            const currentDate = new Date().getDate();
            if (currentDate !== lastDate) {
                updateDailySong();
                lastDate = currentDate;
            }
        }, 60000);
    </script>
</body>
</html>
